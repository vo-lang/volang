// è¯†å­—å†’é™© (Literacy Adventure)
// A Chinese literacy app for kids with Minecraft theme.
// Features: Multiple levels, progress tracking, flashcards with pinyin/meaning/examples.

package main

import "gui"
import "fmt"

// ============ Theme Colors ============

const ColorGreen = "#4ade80"   // Grass green - success, primary
const ColorBrown = "#8b5a2b"   // Dirt brown - borders
const ColorBlue = "#60a5fa"    // Sky blue - secondary
const ColorYellow = "#ffd700"  // Gold - highlights
const ColorRed = "#ee5544"     // Redstone - hanzi, danger
const ColorPurple = "#a855f7"  // Amethyst - special
const ColorBg = "#f5f0e6"      // Beige paper
const ColorBorder = "#d4a574"  // Paper border
const ColorText = "#5a4a42"    // Dark brown text

// ============ Data Types ============

type Character struct {
	Char       string
	Pinyin     string
	Meaning    string
	Words      string   // Comma-separated
	Example    string
	McSentence string
}

type Course struct {
	Id    int
	Name  string
	Icon  string
	Chars []Character
}

type State struct {
	Page          string // "home", "lesson", "complete"
	CurrentCourse int
	CurrentChar   int
	ShowDetail    bool
	Learned       []bool // Track learned characters per course
	Courses       []Course
	TotalLearned  int
}

// ============ Character Data (JSON-style) ============

func loadCourses() []Course {
	return []Course{
		Course{Id: 0, Name: "å…¥é—¨ç¯‡", Icon: "ğŸŒ±", Chars: []Character{
			Character{"ä¸€", "yÄ«", "æ•°å­—1", "ä¸€ä¸ª,ä¸€å¤©,ä¸€èµ·", "æˆ‘æœ‰ä¸€æœ¬ä¹¦ã€‚", "å²è’‚å¤«æ‰¾åˆ°äº†ä¸€å—é’»çŸ³ï¼"},
			Character{"äºŒ", "Ã¨r", "æ•°å­—2", "äºŒæœˆ,ç¬¬äºŒ", "æˆ‘æœ‰äºŒæœ¬ä¹¦ã€‚", "éœ€è¦äºŒä¸ªæœ¨æ£åšæœ¨å‰‘ã€‚"},
			Character{"ä¸‰", "sÄn", "æ•°å­—3", "ä¸‰ä¸ª,ä¸‰å¤©", "ä¸‰ä¸ªè‹¹æœã€‚", "ä¸‰åªåƒµå°¸åœ¨è¿½æˆ‘ï¼"},
			Character{"å", "shÃ­", "æ•°å­—10", "åä¸ª,åå¤©", "æˆ‘æœ‰åå—é’±ã€‚", "æŒ–äº†åä¸ªé“çŸ¿çŸ³ã€‚"},
			Character{"å¤§", "dÃ ", "Big", "å¤§äºº,å¤§å±±,å¤§å®¶", "è¿™æ˜¯ä¸€ä¸ªå¤§è‹¹æœã€‚", "å¥½å¤§çš„ä¸€æ£µæ ‘ï¼"},
			Character{"å°", "xiÇo", "Small", "å°é¸Ÿ,å°å¿ƒ,å°æœ‹å‹", "å°çŒ«å¾ˆå¯çˆ±ã€‚", "å°å¿ƒè‹¦åŠ›æ€•ï¼"},
			Character{"ä¸Š", "shÃ ng", "Up/On", "ä¸Šé¢,ä¸Šå­¦,ä¸Šå±±", "ä¹¦åœ¨æ¡Œå­ä¸Šé¢ã€‚", "çˆ¬ä¸Šå±±é¡¶çœ‹æ—¥å‡ºã€‚"},
			Character{"ä¸‹", "xiÃ ", "Down", "ä¸‹é¢,ä¸‹é›¨,ä¸‹å±±", "é‹å­åœ¨åºŠä¸‹é¢ã€‚", "ä¸‹çŸ¿æ´æŒ–é’»çŸ³ï¼"},
		}},
		Course{Id: 1, Name: "è‡ªç„¶ç¯‡", Icon: "ğŸŒ²", Chars: []Character{
			Character{"å±±", "shÄn", "Mountain", "å¤§å±±,ä¸Šå±±,å±±æ´", "è¿œå¤„æœ‰ä¸€åº§å¤§å±±ã€‚", "æˆ‘ä»¬åœ¨é«˜å±±ä¸Šå»ºåŸå ¡ã€‚"},
			Character{"æ°´", "shuÇ", "Water", "å–æ°´,æ²³æ°´,æ°´æœ", "æˆ‘æƒ³å–æ°´ã€‚", "å°å¿ƒåˆ«æ‰è¿›æ°´é‡Œï¼"},
			Character{"ç«", "huÇ’", "Fire", "ç«è½¦,ç«å±±,ç€ç«", "å°å¿ƒç«ï¼", "ç”¨æ‰“ç«çŸ³ç‚¹ç‡ƒç«æŠŠã€‚"},
			Character{"åœŸ", "tÇ”", "Earth/Soil", "åœŸåœ°,æ³¥åœŸ", "èŠ±é•¿åœ¨åœŸé‡Œã€‚", "æŒ–æ‰æ³¥åœŸæ‰¾çŸ¿çŸ³ã€‚"},
			Character{"æœ¨", "mÃ¹", "Wood", "æœ¨å¤´,æ ‘æœ¨,æœ¨æ£", "è¿™æ˜¯æœ¨å¤´åšçš„ã€‚", "å…ˆç æ ‘æ”¶é›†æœ¨å¤´ï¼"},
			Character{"çŸ³", "shÃ­", "Stone", "çŸ³å¤´,å®çŸ³", "æ²³é‡Œæœ‰å¾ˆå¤šçŸ³å¤´ã€‚", "ç”¨çŸ³å¤´åšçŸ³é•ã€‚"},
			Character{"å¤©", "tiÄn", "Sky/Day", "è“å¤©,ä»Šå¤©,å¤©æ°”", "ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚", "å¤©é»‘äº†ï¼Œåƒµå°¸å‡ºæ¥äº†ï¼"},
			Character{"æ—¥", "rÃ¬", "Sun/Day", "æ—¥å‡º,ç”Ÿæ—¥,æ—¥è®°", "å¤ªé˜³å‡èµ·æ¥äº†ã€‚", "æ—¥å‡ºæ—¶æ€ªç‰©ä¼šç‡ƒçƒ§ã€‚"},
			Character{"æœˆ", "yuÃ¨", "Moon", "æœˆäº®,æœˆé¥¼", "æœˆäº®å¥½åœ†å•Šã€‚", "æ»¡æœˆæ—¶ç‹¼äººä¼šå˜èº«ï¼"},
			Character{"äº‘", "yÃºn", "Cloud", "ç™½äº‘,äº‘æœµ", "å¤©ä¸Šæœ‰ç™½äº‘ã€‚", "é£åˆ°äº‘å±‚ä¸Šé¢å»ï¼"},
		}},
		Course{Id: 2, Name: "åŠ¨ç‰©ç¯‡", Icon: "ğŸ·", Chars: []Character{
			Character{"ç‰›", "niÃº", "Cow", "ç‰›å¥¶,å°ç‰›", "ç‰›åœ¨åƒè‰ã€‚", "ç”¨å°éº¦å–‚ç‰›å¯ä»¥ç¹æ®–ã€‚"},
			Character{"ç¾Š", "yÃ¡ng", "Sheep", "å°ç¾Š,ç¾Šæ¯›", "ç¾Šæ¯›æ˜¯ç™½è‰²çš„ã€‚", "å‰ªç¾Šæ¯›åšåºŠï¼"},
			Character{"é©¬", "mÇ", "Horse", "å°é©¬,é©¬è·¯", "é©¬è·‘å¾—å¾ˆå¿«ã€‚", "é©¯æœä¸€åŒ¹é©¬å½“åéª‘ã€‚"},
			Character{"é¸Ÿ", "niÇo", "Bird", "å°é¸Ÿ,é¸Ÿçª", "å°é¸Ÿä¼šé£ã€‚", "é¹¦é¹‰å¯ä»¥å½“å® ç‰©ï¼"},
			Character{"é±¼", "yÃº", "Fish", "å°é±¼,é±¼å„¿", "é±¼åœ¨æ°´é‡Œæ¸¸ã€‚", "é’“é±¼å¯ä»¥è·å¾—é£Ÿç‰©ã€‚"},
			Character{"è™«", "chÃ³ng", "Insect", "è™«å­,æ¯›è™«", "è‰ä¸›é‡Œæœ‰è™«å­ã€‚", "èœ˜è››ä¼šæ‰èœ˜è››ä¸ã€‚"},
			Character{"çŒª", "zhÅ«", "Pig", "å°çŒª,çŒªè‚‰", "å°çŒªå¾ˆå¯çˆ±ã€‚", "çŒªæ’æ˜¯é‡è¦çš„é£Ÿç‰©ï¼"},
			Character{"ç‹—", "gÇ’u", "Dog", "å°ç‹—,ç‹—ç‹—", "å°ç‹—å¾ˆå¿ è¯šã€‚", "é©¯æœç‹¼å˜æˆç‹—ï¼"},
		}},
		Course{Id: 3, Name: "äººç‰©ç¯‡", Icon: "ğŸ‘¨", Chars: []Character{
			Character{"äºº", "rÃ©n", "Person", "å¤§äºº,å¥½äºº,äººä»¬", "ä»–æ˜¯å¥½äººã€‚", "æ‘åº„é‡Œä½ç€å¾ˆå¤šæ‘æ°‘ã€‚"},
			Character{"å£", "kÇ’u", "Mouth", "é—¨å£,å‡ºå£,äººå£", "å¼ å¼€å£è¯´è¯ã€‚", "å±±æ´çš„å…¥å£åœ¨å“ªé‡Œï¼Ÿ"},
			Character{"æ‰‹", "shÇ’u", "Hand", "å°æ‰‹,å·¦æ‰‹,å³æ‰‹", "æ´—æ´—æ‰‹ã€‚", "ç©ºæ‰‹ä¹Ÿèƒ½æŒ–æœ¨å¤´ï¼"},
			Character{"è¶³", "zÃº", "Foot", "åŒè¶³,è¶³çƒ", "è„šå°åœ¨åœ°ä¸Šã€‚", "ç©¿ä¸Šé´å­è·‘å¾—æ›´å¿«ã€‚"},
			Character{"ç›®", "mÃ¹", "Eye", "ç›®å…‰,çœ¼ç›®", "çå¼€çœ¼ç›çœ‹ã€‚", "æœ«å½±äººä¸å–œæ¬¢è¢«ç›¯ç€çœ‹ã€‚"},
			Character{"è€³", "Ä›r", "Ear", "è€³æœµ,è€³æœº", "ç”¨è€³æœµå¬å£°éŸ³ã€‚", "å¬åˆ°åƒµå°¸çš„å£°éŸ³äº†ï¼"},
		}},
		Course{Id: 4, Name: "åŠ¨ä½œç¯‡", Icon: "ğŸƒ", Chars: []Character{
			Character{"èµ°", "zÇ’u", "Walk", "èµ°è·¯,èµ°å¼€", "æˆ‘ä»¬èµ°å§ã€‚", "èµ°è·¯å¤ªæ…¢äº†ï¼Œè¦è·‘ï¼"},
			Character{"è·‘", "pÇo", "Run", "è·‘æ­¥,å¿«è·‘", "å¿«è·‘ï¼", "è¢«è‹¦åŠ›æ€•è¿½ç€è·‘ï¼"},
			Character{"é£", "fÄ“i", "Fly", "é£æœº,é£é¸Ÿ", "é¸Ÿåœ¨å¤©ä¸Šé£ã€‚", "ç”¨é˜ç¿…å¯ä»¥é£ç¿”ï¼"},
			Character{"åƒ", "chÄ«", "Eat", "åƒé¥­,åƒä¸œè¥¿", "æˆ‘æƒ³åƒè‹¹æœã€‚", "åƒé‡‘è‹¹æœå›è¡€ï¼"},
			Character{"çœ‹", "kÃ n", "Look", "çœ‹è§,çœ‹ä¹¦", "çœ‹é‚£è¾¹ï¼", "çœ‹åœ°å›¾æ‰¾å®è—ã€‚"},
			Character{"æ‰“", "dÇ", "Hit", "æ‰“çƒ,æ‰“äºº", "ä¸è¦æ‰“äººã€‚", "æ‰“è´¥æœ«å½±é¾™ï¼"},
			Character{"åš", "zuÃ²", "Make/Do", "åšé¥­,åšäº‹", "æˆ‘åœ¨åšä½œä¸šã€‚", "ç”¨å·¥ä½œå°åšå·¥å…·ã€‚"},
			Character{"æ‰¾", "zhÇo", "Find", "æ‰¾åˆ°,å¯»æ‰¾", "æˆ‘åœ¨æ‰¾é’¥åŒ™ã€‚", "æ‰¾åˆ°éšè—çš„å®ç®±ï¼"},
		}},
	}
}

// ============ App Entry ============

func main() {
	gui.SetGlobalKeyHandler(handleKey)
	gui.Run(gui.App{
		Init: initApp,
		View: view,
	})
}

func initApp() any {
	courses := loadCourses()
	learned := make([]bool, 50) // Track up to 50 chars
	return &State{
		Page:          "home",
		CurrentCourse: 0,
		CurrentChar:   0,
		ShowDetail:    false,
		Learned:       learned,
		Courses:       courses,
		TotalLearned:  0,
	}
}

// ============ Update Logic ============

func handleKey(state any, key string) {
	s := state.(*State)
	if s.Page == "lesson" {
		if key == "ArrowLeft" {
			actionPrevChar(s)
		} else if key == "ArrowRight" {
			actionNextChar(s)
		} else if key == " " || key == "Enter" {
			actionToggleDetail(s)
		} else if key == "Escape" {
			actionGoHome(s)
		}
	}
}

func actionSelectCourse(s *State, idx int) {
	s.CurrentCourse = idx
	s.CurrentChar = 0
	s.ShowDetail = false
	s.Page = "lesson"
}

func actionGoHome(s *State) {
	s.Page = "home"
}

func actionNextChar(s *State) {
	course := s.Courses[s.CurrentCourse]
	// Mark current as learned
	charIdx := getGlobalCharIndex(s)
	if charIdx < len(s.Learned) && !s.Learned[charIdx] {
		s.Learned[charIdx] = true
		s.TotalLearned++
	}
	if s.CurrentChar < len(course.Chars)-1 {
		s.CurrentChar++
		s.ShowDetail = false
	} else {
		s.Page = "complete"
	}
}

func actionPrevChar(s *State) {
	if s.CurrentChar > 0 {
		s.CurrentChar--
		s.ShowDetail = false
	}
}

func actionToggleDetail(s *State) {
	s.ShowDetail = !s.ShowDetail
}

func actionContinue(s *State) {
	s.Page = "home"
}

func getGlobalCharIndex(s *State) int {
	idx := 0
	for i := 0; i < s.CurrentCourse; i++ {
		idx += len(s.Courses[i].Chars)
	}
	return idx + s.CurrentChar
}

func getTotalChars(s *State) int {
	total := 0
	for _, c := range s.Courses {
		total += len(c.Chars)
	}
	return total
}

// ============ View ============

func view(state any) gui.Node {
	s := state.(*State)
	if s.Page == "home" {
		return viewHome(s)
	}
	if s.Page == "complete" {
		return viewComplete(s)
	}
	return viewLesson(s)
}

func viewHome(s *State) gui.Node {
	total := getTotalChars(s)
	progress := 0
	if total > 0 {
		progress = s.TotalLearned * 100 / total
	}

	var courseNodes []gui.Node
	for i, c := range s.Courses {
		idx := i
		courseNodes = append(courseNodes,
			gui.Button(fmt.Sprintf("%s %s (%då­—)", c.Icon, c.Name, len(c.Chars)), gui.OnInt(actionSelectCourse, idx)).
				Bg(ColorGreen).
				Fg("#fff").
				Rounded(10).
				M(5).
				P(15).
				Border("3px solid "+ColorBrown),
		)
	}

	return gui.Center(
		gui.Column(
			// Title
			gui.Row(
				gui.Text("ğŸ® è¯†å­—").Font(28).Bold().Fg(ColorGreen),
				gui.Text("å†’é™©").Font(28).Bold().Fg(ColorBrown),
			).M(15),

			// Progress
			gui.Column(
				gui.Text(fmt.Sprintf("å·²å­¦ä¹ : %d / %d å­—", s.TotalLearned, total)).Font(14).Fg(ColorText),
				gui.Row(
					gui.Node{Type: "Block"}.W(progress*2).H(8).Bg(ColorGreen).Rounded(4),
					gui.Node{Type: "Block"}.W((100-progress)*2).H(8).Bg("#ddd").Rounded(4),
				).Gap(0),
			).M(10).P(10).Bg("#fff").Rounded(8).Border("2px solid "+ColorBorder),

			// Course List
			gui.Text("é€‰æ‹©è¯¾ç¨‹:").Font(16).Bold().Fg(ColorText).M(10),
			gui.Column(courseNodes...).Gap(5),

			// Footer
			gui.Text("â† â†’ æ–¹å‘é”®å¯¼èˆª | Space æ˜¾ç¤ºè¯¦æƒ…").Font(11).Fg("#999").M(15),
		).Bg(ColorBg).P(15).Gap(5).W(300),
	)
}

func viewLesson(s *State) gui.Node {
	course := s.Courses[s.CurrentCourse]
	char := course.Chars[s.CurrentChar]

	return gui.Column(
		// Navbar
		gui.Row(
			gui.Button("â† è¿”å›", gui.On(actionGoHome)).
				Bg(ColorRed).Fg("#fff").Rounded(8).P(8),
			gui.Spacer(),
			gui.Text(fmt.Sprintf("%s %s  %d/%d", course.Icon, course.Name, s.CurrentChar+1, len(course.Chars))).
				Font(14).Fg(ColorText).Bold(),
			gui.Spacer(),
		).P(8).Bg(ColorBg).Border("0 0 2px 0 solid "+ColorBorder),

		// Main Content
		gui.Center(
			gui.Column(
				// Pinyin (Conditional)
				gui.Show(s.ShowDetail,
					gui.Text(char.Pinyin).Font(32).Fg(ColorPurple).Bold().M(5),
				),

				// Hanzi Card
				gui.Button(char.Char, gui.On(actionToggleDetail)).
					Font(90).
					Fg(ColorRed).
					Bg("#fff").
					W(160).H(160).
					Border("4px dashed "+ColorBorder).
					Rounded(10),

				// Hint
				gui.Show(!s.ShowDetail,
					gui.Text("ğŸ‘† ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…").Font(12).Fg("#999").M(8),
				),

				// Details
				gui.Show(s.ShowDetail,
					gui.Column(
						gui.Row(
							gui.Text("ğŸ“– é‡Šä¹‰: ").Bold().Fg(ColorBrown),
							gui.Text(char.Meaning).Fg(ColorText),
						),
						gui.Row(
							gui.Text("ğŸ“ ç»„è¯: ").Bold().Fg(ColorBrown),
							gui.Text(char.Words).Fg(ColorText),
						),
						gui.Row(
							gui.Text("ğŸ’¬ ä¾‹å¥: ").Bold().Fg(ColorBrown),
							gui.Text(char.Example).Fg(ColorText),
						),
					).P(12).Bg("#fff").Rounded(8).Border("2px solid "+ColorBorder).M(8).Gap(8),
				),

				// Minecraft Sentence
				gui.Column(
					gui.Text("â›ï¸ Minecraft é€ å¥").Bold().Fg(ColorYellow),
					gui.Text(char.McSentence).Fg("#fff").Font(14),
				).P(12).M(5).Bg("#2d2d2d").Rounded(8).Border("3px solid "+ColorBrown),
			).Gap(5),
		).Flex(1),

		// Navigation
		gui.Row(
			gui.If(s.CurrentChar > 0,
				gui.Button("â—€ ä¸Šä¸€ä¸ª", gui.On(actionPrevChar)).
					Bg(ColorBlue).Fg("#fff").Rounded(20).P(10),
			),
			gui.Spacer(),
			gui.Button("ä¸‹ä¸€ä¸ª â–¶", gui.On(actionNextChar)).
				Bg(ColorGreen).Fg("#fff").Rounded(20).P(10),
		).P(15),
	).Bg(ColorBg).W(300)
}

func viewComplete(s *State) gui.Node {
	course := s.Courses[s.CurrentCourse]
	return gui.Center(
		gui.Column(
			gui.Text("ğŸ‰").Font(60),
			gui.Text("å¤ªæ£’äº†ï¼").Font(28).Bold().Fg(ColorGreen),
			gui.Text(fmt.Sprintf("ä½ å®Œæˆäº† %sï¼", course.Name)).Font(16).Fg(ColorText),
			gui.Text(fmt.Sprintf("å­¦ä¹ äº† %d ä¸ªæ±‰å­—", len(course.Chars))).Font(14).Fg(ColorText).M(10),
			gui.Button("ç»§ç»­å­¦ä¹ ", gui.On(actionContinue)).
				Bg(ColorGreen).Fg("#fff").Rounded(10).P(15).M(20),
		).Bg(ColorBg).P(30).Rounded(15).Border("4px solid "+ColorBorder).Gap(10).W(300),
	)
}
