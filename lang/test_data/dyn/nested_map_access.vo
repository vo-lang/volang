// Test dynamic access on nested maps
// BUG: Nested map[string]any access causes issues
package main


import "fmt"
func main() error {
    // Create nested map structure
    inner1 := map[string]any{
        "x": 10,
        "y": 20,
    }
    inner2 := map[string]any{
        "a": "hello",
        "b": "world",
    }
    outer := map[string]any{
        "coords": inner1,
        "words":  inner2,
        "count":  42,
    }
    
    var obj any = outer
    
    // Access top-level - this should work
    count := obj~>count?
    assert(count.(int) == 42, "count should be 42")
    
    // Access nested map - get inner map first
    coords := obj~>coords?
    
    // BUG: Accessing fields on the nested map causes issues
    x := coords~>x?
    assert(x.(int) == 10, "coords.x should be 10")
    
    y := coords~>y?
    assert(y.(int) == 20, "coords.y should be 20")
    
    // Access another nested map
    words := obj~>words?
    a := words~>a?
    assert(a.(string) == "hello", "words.a should be 'hello'")
    
    b := words~>b?
    assert(b.(string) == "world", "words.b should be 'world'")
    
    // Modify nested value
    coords~>x = 100
    x = coords~>x?
    assert(x.(int) == 100, "coords.x should be 100 after update")
    
    // Add new key to nested map
    coords~>z = 30
    z := coords~>z?
    assert(z.(int) == 30, "coords.z should be 30")
    
    // Verify changes reflect in original
    assert(inner1["x"].(int) == 100, "original inner1 x should be updated")
    assert(inner1["z"].(int) == 30, "original inner1 z should be added")
    
    fmt.Println("nested_map_access: ok")
    return nil
}
