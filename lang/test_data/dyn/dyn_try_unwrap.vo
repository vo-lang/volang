package main


import "fmt"
type Point struct {
	x int
	y int
}

func testDynFieldWithTryUnwrap() error {
	var p Point
	p.x = 42
	p.y = 100
	
	var obj any = p
	
	// Test 1: x = obj~>field? with correct type
	var x int
	x = obj~>x?
	assert(x == 42, "expected x=42, got ", x)
	
	// Test 2: y = obj~>field? with correct type
	var y int
	y = obj~>y?
	assert(y == 100, "expected y=100, got ", y)
	
	fmt.Println("testDynFieldWithTryUnwrap passed")
	return nil
}

func testDynFieldTypeMismatch() error {
	var p Point
	p.x = 42
	
	var obj any = p
	
	// This should fail at runtime: obj~>x returns int, but we expect string
	var s string
	s = obj~>x?
	
	// Should not reach here
	fmt.Println("ERROR: should have failed with type mismatch, got s=", s)
	return nil
}

func testDynFieldNotFound() error {
	var p Point
	p.x = 42
	
	var obj any = p
	
	// This should fail: field "z" doesn't exist
	var z int
	z = obj~>z?
	
	// Should not reach here
	fmt.Println("ERROR: should have failed with field not found, got z=", z)
	return nil
}

func testTryUnwrapRequiresErrorReturn() {
	// This function has no error return, so ? should not be allowed
	// This is a compile-time check, not runtime
	// Uncomment to verify compile error:
	// var obj any = 1
	// var x int
	// x = obj~>value?  // ERROR: ? operator requires function with error return value
}

func main() {
	// Test 1: Basic dyn field access with ? (should pass)
	err := testDynFieldWithTryUnwrap()
	if err != nil {
		fmt.Println("testDynFieldWithTryUnwrap failed:", err.Error())
		return
	}
	
	// Test 2: Type mismatch (should fail with error, not panic)
	err = testDynFieldTypeMismatch()
	if err != nil {
		fmt.Println("testDynFieldTypeMismatch correctly failed with error:", err.Error())
	} else {
		fmt.Println("ERROR: testDynFieldTypeMismatch should have failed")
	}
	
	// Test 3: Field not found (should fail with error)
	err = testDynFieldNotFound()
	if err != nil {
		fmt.Println("testDynFieldNotFound correctly failed with error:", err.Error())
	} else {
		fmt.Println("ERROR: testDynFieldNotFound should have failed")
	}
	
	fmt.Println("All tests completed")
}
