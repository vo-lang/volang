// Test dynamic write to embedded (promoted) struct fields
// Verifies that ~> assignment works on fields promoted from embedded structs.
package main


import "fmt"
type Base struct {
    id   int
    name string
}

type Derived struct {
    Base
    extra string
}

type DeepDerived struct {
    Derived
    level int
}

func main() {
    // Test 1: Write to promoted field from embedded struct
    d := &Derived{
        Base:  Base{id: 100, name: "original"},
        extra: "extra",
    }
    var obj any = d
    
    obj~>id = 200
    assert(d.id == 200, "embedded id should be 200")
    fmt.Println("Test 1: d.id =", d.id)
    
    obj~>name = "modified"
    assert(d.name == "modified", "embedded name should be 'modified'")
    fmt.Println("Test 2: d.name =", d.name)
    
    // Test 3: Write to non-embedded field
    obj~>extra = "new-extra"
    assert(d.extra == "new-extra", "extra should be 'new-extra'")
    fmt.Println("Test 3: d.extra =", d.extra)
    
    // Test 4: Write to embedded struct as a whole
    obj~>Base = Base{id: 300, name: "replaced"}
    assert(d.id == 300, "Base.id should be 300")
    assert(d.name == "replaced", "Base.name should be 'replaced'")
    fmt.Println("Test 4: d.Base = {", d.id, ",", d.name, "}")
    
    // Test 5: Deep embedding write
    dd := &DeepDerived{
        Derived: Derived{
            Base:  Base{id: 1, name: "deep"},
            extra: "deep-extra",
        },
        level: 1,
    }
    var ddObj any = dd
    
    ddObj~>id = 999
    assert(dd.id == 999, "deep id should be 999")
    fmt.Println("Test 5: dd.id =", dd.id)
    
    ddObj~>name = "deep-modified"
    assert(dd.name == "deep-modified", "deep name should be 'deep-modified'")
    fmt.Println("Test 6: dd.name =", dd.name)
    
    ddObj~>extra = "deep-extra-modified"
    assert(dd.extra == "deep-extra-modified", "deep extra should be modified")
    fmt.Println("Test 7: dd.extra =", dd.extra)
    
    ddObj~>level = 42
    assert(dd.level == 42, "level should be 42")
    fmt.Println("Test 8: dd.level =", dd.level)
    
    fmt.Println("dyn_embed_field_write: ok")
}
