// Test named type embedding a type with DynAttr protocol
// Named type should inherit the DynAttr implementation
package main

import (
	"fmt"
	"dyn"
)

type Base struct {
    data map[string]any
}

func (b *Base) DynAttr(name string) (any, error) {
    v, ok := b.data[name]
    if !ok {
        return nil, dyn.ErrBadField
    }
    return v, nil
}

func (b *Base) DynSetAttr(name string, val any) error {
    b.data[name] = val
    return nil
}

// Named type that embeds Base
type Extended struct {
    Base
    extra int
}

func NewExtended() *Extended {
    return &Extended{
        Base:  Base{data: make(map[string]any)},
        extra: 100,
    }
}

// Named type that embeds pointer to Base
type ExtendedPtr struct {
    *Base
    extra int
}

func NewExtendedPtr() *ExtendedPtr {
    return &ExtendedPtr{
        Base:  &Base{data: make(map[string]any)},
        extra: 200,
    }
}

func main() {
    // Test 1: Extended (embeds Base by value)
    ext := NewExtended()
    ext.data["foo"] = "bar"
    ext.data["count"] = 42
    
    var obj any = ext
    
    // Access via inherited DynAttr
    foo := obj~>foo?
    assert(foo.(string) == "bar", "foo should be 'bar'")
    
    count := obj~>count?
    assert(count.(int) == 42, "count should be 42")
    
    // Set via inherited DynSetAttr
    obj~>newkey = "newval"
    assert(ext.data["newkey"].(string) == "newval", "newkey should be set")
    
    // Access the struct field 'extra' - this should go through struct access, not DynAttr
    extraVal := obj~>extra?
    assert(extraVal.(int) == 100, "extra should be 100")
    
    // Test 2: ExtendedPtr (embeds *Base)
    extPtr := NewExtendedPtr()
    extPtr.data["x"] = 1
    extPtr.data["y"] = 2
    
    var objPtr any = extPtr
    
    x := objPtr~>x?
    assert(x.(int) == 1, "x should be 1")
    
    y := objPtr~>y?
    assert(y.(int) == 2, "y should be 2")
    
    objPtr~>z = 3
    assert(extPtr.data["z"].(int) == 3, "z should be set to 3")
    
    // Access extra field
    extraVal2 := objPtr~>extra?
    assert(extraVal2.(int) == 200, "extra should be 200")
    
    fmt.Println("dyn_named_embed_protocol: ok")
}
