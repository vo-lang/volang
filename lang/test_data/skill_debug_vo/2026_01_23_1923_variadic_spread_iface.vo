package main

// Test variadic functions with spread operators and interfaces

type Stringer interface {
	String() string
}

type MyInt int

func (m MyInt) String() string {
	return "int"
}

type MyStr string

func (m MyStr) String() string {
	return string(m)
}

func concatStrings(items ...Stringer) string {
	result := ""
	for _, item := range items {
		if item != nil {
			result += item.String() + ","
		} else {
			result += "nil,"
		}
	}
	return result
}

func testBasicVariadicSpread() {
	var items []Stringer
	items = append(items, MyInt(1))
	items = append(items, MyStr("hello"))
	items = append(items, MyInt(2))
	
	result := concatStrings(items...)
	assert(result == "int,hello,int,", "basic spread: got %s", result)
}

func testEmptySliceSpread() {
	var items []Stringer
	result := concatStrings(items...)
	assert(result == "", "empty slice spread should work")
}

func testNilSliceSpread() {
	var items []Stringer = nil
	result := concatStrings(items...)
	assert(result == "", "nil slice spread should work")
}

func testMixedDirectAndSpread() {
	var items []Stringer
	items = append(items, MyStr("a"))
	items = append(items, MyStr("b"))
	
	// Direct args first, then spread
	result := concatStrings(MyInt(0), items[0], items[1])
	assert(result == "int,a,b,", "mixed args: got %s", result)
}

func testSpreadWithNilElements() {
	var items []Stringer
	items = append(items, MyInt(1))
	items = append(items, nil)
	items = append(items, MyStr("after nil"))
	
	result := concatStrings(items...)
	assert(result == "int,nil,after nil,", "nil elements: got %s", result)
}

func testVariadicWithAny() {
	collect := func(items ...any) int {
		return len(items)
	}
	
	// Spread []any
	var anyItems []any
	anyItems = append(anyItems, 1)
	anyItems = append(anyItems, "two")
	anyItems = append(anyItems, 3.0)
	
	count := collect(anyItems...)
	assert(count == 3, "any spread count: got %d", count)
}

func testVariadicInterfaceConversion() {
	// Function taking []any variadic
	sum := func(items ...any) int {
		total := 0
		for _, item := range items {
			if n, ok := item.(int); ok {
				total += n
			}
		}
		return total
	}
	
	// Spread []Stringer into ...any should convert each element
	var stringers []Stringer
	stringers = append(stringers, MyInt(10))
	stringers = append(stringers, MyInt(20))
	
	// This tests if []Stringer can be spread into ...any
	// Each element should be boxed as any
	result := sum(stringers[0], stringers[1])
	// Note: MyInt(10) as any, then type asserted to int won't work
	// because MyInt != int
	assert(result == 0, "MyInt is not int: got %d", result)
}

func testNestedVariadicCall() {
	inner := func(items ...Stringer) string {
		return concatStrings(items...)
	}
	
	var items []Stringer
	items = append(items, MyStr("nested"))
	items = append(items, MyStr("call"))
	
	result := inner(items...)
	assert(result == "nested,call,", "nested variadic: got %s", result)
}

func testVariadicInClosure() {
	var captured []Stringer
	captured = append(captured, MyInt(1))
	captured = append(captured, MyStr("cap"))
	
	f := func() string {
		return concatStrings(captured...)
	}
	
	result := f()
	assert(result == "int,cap,", "closure variadic: got %s", result)
	
	// Modify captured
	captured = append(captured, MyInt(2))
	result = f()
	assert(result == "int,cap,int,", "modified closure variadic: got %s", result)
}

func testVariadicReturnSpread() {
	makeItems := func() []Stringer {
		var items []Stringer
		items = append(items, MyStr("ret"))
		items = append(items, MyStr("spread"))
		return items
	}
	
	result := concatStrings(makeItems()...)
	assert(result == "ret,spread,", "return spread: got %s", result)
}

func testSingleElementSpread() {
	var items []Stringer
	items = append(items, MyStr("single"))
	
	result := concatStrings(items...)
	assert(result == "single,", "single element: got %s", result)
}

func testVariadicWithDefer() {
	var result string
	
	f := func() {
		var items []Stringer
		items = append(items, MyStr("defer"))
		
		defer func() {
			result = concatStrings(items...)
		}()
		
		items = append(items, MyStr("modified"))
	}
	
	f()
	assert(result == "defer,modified,", "defer variadic: got %s", result)
}

func main() {
	testBasicVariadicSpread()
	testEmptySliceSpread()
	testNilSliceSpread()
	testMixedDirectAndSpread()
	testSpreadWithNilElements()
	testVariadicWithAny()
	testVariadicInterfaceConversion()
	testNestedVariadicCall()
	testVariadicInClosure()
	testVariadicReturnSpread()
	testSingleElementSpread()
	testVariadicWithDefer()
	
	println("All variadic spread interface tests passed!")
}
