package main

// Test map operations with interface keys and values - edge cases

type Comparable interface {
	Compare(other Comparable) int
}

type IntVal int

func (i IntVal) Compare(other Comparable) int {
	if o, ok := other.(IntVal); ok {
		if int(i) < int(o) {
			return -1
		} else if int(i) > int(o) {
			return 1
		}
		return 0
	}
	return -1
}

func testMapWithInterfaceValue() {
	m := make(map[string]Comparable)
	m["a"] = IntVal(10)
	m["b"] = IntVal(20)
	
	assert(m["a"].Compare(IntVal(10)) == 0, "a should equal 10")
	assert(m["a"].Compare(IntVal(20)) == -1, "a should be less than 20")
	assert(m["b"].Compare(IntVal(10)) == 1, "b should be greater than 10")
}

func testMapWithAnyKey() {
	m := make(map[any]int)
	m[1] = 100
	m["str"] = 200
	m[true] = 300
	
	assert(m[1] == 100, "int key")
	assert(m["str"] == 200, "string key")
	assert(m[true] == 300, "bool key")
	
	// Test overwrite
	m[1] = 999
	assert(m[1] == 999, "overwritten int key")
}

func testMapWithAnyValue() {
	m := make(map[string]any)
	m["int"] = 42
	m["str"] = "hello"
	m["bool"] = true
	
	if v, ok := m["int"].(int); ok {
		assert(v == 42, "int value")
	} else {
		panic("should be int")
	}
	
	if v, ok := m["str"].(string); ok {
		assert(v == "hello", "string value")
	} else {
		panic("should be string")
	}
}

func testMapDeleteWithAnyKey() {
	m := make(map[any]string)
	m[1] = "one"
	m[2] = "two"
	m["three"] = "three"
	
	delete(m, 1)
	_, ok := m[1]
	assert(!ok, "1 should be deleted")
	
	assert(m[2] == "two", "2 should still exist")
	assert(m["three"] == "three", "three should still exist")
}

func testMapRangeWithAnyKey() {
	m := make(map[any]int)
	m[1] = 10
	m[2] = 20
	m[3] = 30
	
	sum := 0
	for _, v := range m {
		sum += v
	}
	assert(sum == 60, "sum should be 60, got %d", sum)
}

func testMapWithStructKey() {
	type Point struct {
		x, y int
	}
	
	m := make(map[Point]string)
	m[Point{1, 2}] = "one-two"
	m[Point{3, 4}] = "three-four"
	
	assert(m[Point{1, 2}] == "one-two", "point key 1,2")
	assert(m[Point{3, 4}] == "three-four", "point key 3,4")
	
	// Non-existent key
	v, ok := m[Point{5, 6}]
	assert(!ok, "5,6 should not exist")
	assert(v == "", "default value should be empty string")
}

func testMapInterfaceValueNil() {
	m := make(map[string]Comparable)
	m["nil"] = nil
	m["val"] = IntVal(5)
	
	assert(m["nil"] == nil, "nil value should be nil")
	assert(m["val"] != nil, "val should not be nil")
	
	// Range over map with nil value
	count := 0
	for _, v := range m {
		if v == nil {
			count++
		}
	}
	assert(count == 1, "should have 1 nil value, got %d", count)
}

func testMapLookupCommaOk() {
	m := make(map[any]any)
	m["exists"] = 42
	m["nil"] = nil
	
	// Exists with non-nil value
	v1, ok1 := m["exists"]
	assert(ok1, "exists should be found")
	assert(v1.(int) == 42, "exists value")
	
	// Exists with nil value
	v2, ok2 := m["nil"]
	assert(ok2, "nil key should be found")
	assert(v2 == nil, "nil value")
	
	// Does not exist
	v3, ok3 := m["nope"]
	assert(!ok3, "nope should not be found")
	assert(v3 == nil, "default any value should be nil")
}

func testMapInClosure() {
	m := make(map[string]int)
	m["a"] = 1
	
	get := func(key string) int {
		return m[key]
	}
	
	set := func(key string, val int) {
		m[key] = val
	}
	
	assert(get("a") == 1, "initial a")
	set("a", 100)
	assert(get("a") == 100, "updated a")
	
	set("b", 200)
	assert(get("b") == 200, "new b")
}

func testMapAssignInLoop() {
	m := make(map[int]int)
	
	for i := 0; i < 5; i++ {
		m[i] = i * 10
	}
	
	assert(len(m) == 5, "should have 5 elements")
	assert(m[0] == 0, "m[0]")
	assert(m[4] == 40, "m[4]")
}

func testMapWithInterfaceKeyComparison() {
	// Map with any key - test that different types don't collide
	m := make(map[any]string)
	m[1] = "int 1"
	m["1"] = "string 1"
	m[true] = "bool true"
	m[1.0] = "float 1.0"
	
	assert(m[1] == "int 1", "int key")
	assert(m["1"] == "string 1", "string key")
	assert(m[true] == "bool true", "bool key")
	assert(m[1.0] == "float 1.0", "float key")
	
	assert(len(m) == 4, "should have 4 distinct keys, got %d", len(m))
}

func main() {
	testMapWithInterfaceValue()
	testMapWithAnyKey()
	testMapWithAnyValue()
	testMapDeleteWithAnyKey()
	testMapRangeWithAnyKey()
	testMapWithStructKey()
	testMapInterfaceValueNil()
	testMapLookupCommaOk()
	testMapInClosure()
	testMapAssignInLoop()
	testMapWithInterfaceKeyComparison()
	
	println("All map interface key edge tests passed!")
}
