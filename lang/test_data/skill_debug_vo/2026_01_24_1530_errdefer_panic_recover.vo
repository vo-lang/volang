package main

import "errors"

// Regression test: errdefer should NOT run when panic is recovered
// Bug: errdefer was incorrectly running after panic recovery because
// when switching from Panic to Return mode, errdefers were not filtered out.

// Test 1: Basic case - errdefer should not run after recover
func basicErrdeferRecover() (result int, err error) {
	result = 100
	
	errdefer func() {
		result = -1
	}()
	
	defer func() {
		if r := recover(); r != nil {
			result = 999
		}
	}()
	
	panic("test")
}

func testBasicErrdeferRecover() {
	r, err := basicErrdeferRecover()
	assert(err == nil, "no error")
	assert(r == 999, "basic errdefer recover: expected 999, got")
}

// Test 2: Multiple errdefers - none should run after recover
func multipleErrdefers() (result int, err error) {
	result = 0
	
	errdefer func() {
		result += 1000
	}()
	
	errdefer func() {
		result += 100
	}()
	
	defer func() {
		if r := recover(); r != nil {
			result = 42
		}
	}()
	
	errdefer func() {
		result += 10
	}()
	
	panic("test")
}

func testMultipleErrdefers() {
	r, err := multipleErrdefers()
	assert(err == nil, "no error")
	// Only the recover defer should have run
	assert(r == 42, "multiple errdefers: expected 42")
}

// Test 3: Mixed defer and errdefer
// Errdefers that run BEFORE recover still execute (panic mode)
// Only errdefers AFTER recover (in the pending list) get filtered
func mixedDeferErrdefer() (result int, err error) {
	result = 0
	
	defer func() {
		result += 1
	}()
	
	errdefer func() {
		result += 1000
	}()
	
	defer func() {
		if r := recover(); r != nil {
			result += 10
		}
	}()
	
	errdefer func() {
		result += 100
	}()
	
	panic("test")
}

func testMixedDeferErrdefer() {
	r, err := mixedDeferErrdefer()
	assert(err == nil, "no error")
	// LIFO order:
	// 1. errdefer(+100): runs in panic mode, result = 100
	// 2. defer(recover, +10): recovers, result = 110, filters remaining errdefers
	// 3. errdefer(+1000): SKIPPED (filtered after recover)
	// 4. defer(+1): runs, result = 111
	assert(r == 111, "mixed defer errdefer: expected 111")
}

// Test 4: errdefer SHOULD run when returning with error (not panic)
func errdeferWithError() (result int, err error) {
	result = 0
	
	errdefer func() {
		result += 100
	}()
	
	fail errors.New("actual error")
}

func testErrdeferWithError() {
	r, err := errdeferWithError()
	assert(err != nil, "should have error")
	// errdefer should run
	assert(r == 100, "errdefer with error: expected 100")
}

// Test 5: Nested function with errdefer - panic in inner, recover in outer
func nestedErrdeferPanic() (result int, err error) {
	result = 0
	
	errdefer func() {
		result += 1000
	}()
	
	defer func() {
		if r := recover(); r != nil {
			result = 50
		}
	}()
	
	func() {
		panic("inner panic")
	}()
	
	return result, nil
}

func testNestedErrdeferPanic() {
	r, err := nestedErrdeferPanic()
	assert(err == nil, "no error")
	assert(r == 50, "nested errdefer panic: expected 50")
}

func main() {
	testBasicErrdeferRecover()
	println("Test 1: PASSED - basic errdefer recover")
	
	testMultipleErrdefers()
	println("Test 2: PASSED - multiple errdefers")
	
	testMixedDeferErrdefer()
	println("Test 3: PASSED - mixed defer errdefer")
	
	testErrdeferWithError()
	println("Test 4: PASSED - errdefer with error")
	
	testNestedErrdeferPanic()
	println("Test 5: PASSED - nested errdefer panic")
	
	println("ALL PASSED")
}
