# Cross-Platform Vo Graphics: Overview & Architecture

> Date: 2026-02-22  
> Status: Final design — ready for implementation  
> Related docs:  
> - `2026-02-22_01_tauri_wrapper.md`  
> - `2026-02-22_02_native_playground.md`  
> - `2026-02-22_03_wgpu_wrapper.md`

---

## 1. Goals

| # | Deliverable | Description |
|---|-------------|-------------|
| 1 | **Tauri wrapper** (`libs/vo-tauri`) | Reusable Rust crate that bridges the Vo engine to a Tauri webview — compile, run, GUI lifecycle, IPC. Any Tauri-based Vo app can depend on it. |
| 2 | **Native playground** (`apps/playground-desktop`) | Desktop app using Tauri + vogui. Same UX as the web playground but runs Vo natively: faster compilation, JIT support, filesystem access, bundled extensions. |
| 3 | **Cross-platform wgpu wrapper** (`3rdparty/wgpu`) | Single Vo package `wgpu` with two Rust backends — web (wasm-bindgen + web-sys / WebGPU) and native (wgpu crate). Same `.vo` API on both platforms. Tested on both playgrounds. |

## 2. Non-Goals

- Custom native UI renderer for vogui (continue using the webview JS renderer on all platforms).
- OpenGL or Metal or Vulkan backends exposed directly — wgpu abstracts them.
- Mobile targets (iOS/Android) in this phase.
- Designing a "Vo graphics interface API" — this is a wgpu wrapper, not an abstraction layer.

---

## 3. Current State

### 3.1 Architecture Map

```
┌─────────────── Web Playground ───────────────┐
│  Svelte frontend ─→ Editor, Output, GuiPreview│
│  vo.ts           ─→ loadWasm, voCallExt       │
│  playground/rust ─→ vo-web + vogui (WASM)     │
│  vogui JS        ─→ morphdom DOM renderer     │
│  wgpu ext        ─→ wasm-bindgen + web-sys    │
└───────────────────────────────────────────────┘

┌─────────────── Native CLI ────────────────────┐
│  cmd/vo          ─→ vo-engine (compile + run) │
│  vo-vm           ─→ VM + JIT                  │
│  vo-runtime      ─→ GC, FFI, extern registry  │
│  vo-ext          ─→ #[vo_fn] native externs   │
│  ExtensionLoader ─→ dlopen shared libs        │
│  vogui native    ─→ no-op stubs (no UI)       │
│  wgpu native     ─→ NOT SUPPORTED YET         │
└───────────────────────────────────────────────┘
```

### 3.2 Key Crates & Their Roles

| Crate | Role | Web | Native |
|-------|------|-----|--------|
| `vo-engine` | Compile + run orchestration | ✗ | ✓ |
| `vo-web` | WASM bindings, VM management | ✓ | ✗ |
| `vo-vm` | Bytecode VM + JIT | ✓ (WASM) | ✓ |
| `vo-runtime` | GC, FFI, ExternRegistry | ✓ | ✓ |
| `vo-ext` / `vo-ffi-macro` | `#[vo_fn]` proc macro | ✗ | ✓ |
| `vo-stdlib` | stdlib extern impls | ✓ | ✓ |
| `vogui/rust` | GUI externs (emitRender, timers) | ✓ (wasm_bindgen) | ✓ (no-op stubs) |
| `vogui/js` | DOM renderer (morphdom) | ✓ | ✗ |
| `vo-web-runtime-wasm` | OS/time/HTTP/ext-bridge for WASM | ✓ | ✗ |
| `3rdparty/wgpu` | WebGPU rendering | ✓ (web-sys) | ✗ |

### 3.3 Critical Constraints

| Constraint | Impact | Solution |
|------------|--------|----------|
| vogui native stubs are no-ops | Timers, navigation don't work natively | VoguiPlatform trait → Tauri impl forwards to webview |
| wgpu is web-only (web-sys) | Cannot render natively | Add wgpu crate backend behind `#[cfg]` |
| Ext bridge is JS-only (`voCallExt`) | No native 3rd-party ext loading | Bundled linking for playground; ExtensionLoader for CLI |
| Playground frontend coupled to WASM | Can't swap to Tauri IPC | Platform abstraction interface in TypeScript |
| wgpu needs a Surface to render to | On web: canvas element. On native: ? | Native: child window overlay via raw-window-handle |

---

## 4. Target Architecture

```
┌────────────── Web Playground ──────────────────────┐
│  Svelte + platform.ts (WasmPlatform)               │
│  ↕ WASM calls                                      │
│  vo-web (WASM) → VM → vogui externs → emitRender   │
│  wgpu ext (WASM) → web-sys WebGPU → canvas         │
│  vogui JS renderer → morphdom → DOM                │
└────────────────────────────────────────────────────┘

┌────────────── Native Playground (Tauri) ───────────┐
│  Svelte + platform.ts (TauriPlatform)              │
│  ↕ Tauri IPC (invoke / emit)                       │
│  vo-tauri → vo-engine → VM+JIT → vogui externs     │
│  wgpu ext (native) → wgpu crate → native surface   │
│  vogui JS renderer → morphdom → webview DOM        │
│  Canvas: native child window overlay at placeholder │
└────────────────────────────────────────────────────┘

┌────────────── Standalone Native App ───────────────┐
│  cmd/vo run app.vo                                 │
│  vo-engine → VM+JIT                                │
│  wgpu ext → dlopen libvo_wgpu.so → wgpu crate     │
│  (No UI — headless compute, or future winit UI)    │
└────────────────────────────────────────────────────┘
```

### 4.1 Shared Frontend

The Svelte frontend is shared between web and desktop playgrounds. The only difference is the platform adapter:

```typescript
interface VoPlatform {
    initGuiApp(source: string): Promise<GuiResult>;
    initGuiAppWithModules(source: string): Promise<GuiResult>;
    handleGuiEvent(id: number, payload: string): Promise<GuiResult>;
    compileAndRun(source: string): Promise<RunResult>;
}
```

- `WasmPlatform` — wraps current `vo.ts` WASM calls
- `TauriPlatform` — wraps `@tauri-apps/api/core` invoke calls

### 4.2 vogui Platform Trait

Replace `#[cfg(wasm32)]` / `#[cfg(not(wasm32))]` blocks with a trait:

```rust
pub trait VoguiPlatform: 'static {
    fn start_timeout(&self, id: i32, ms: i32);
    fn clear_timeout(&self, id: i32);
    fn start_interval(&self, id: i32, ms: i32);
    fn clear_interval(&self, id: i32);
    fn navigate(&self, path: &str);
    fn get_current_path(&self) -> String;
}
```

Three impls: `WasmPlatform`, `TauriPlatform`, `NoopPlatform`.

### 4.3 wgpu Dual Backend

Single Vo package, two Rust backends selected at compile time:

```
wgpu.vo (shared API)
    ↓ extern calls
┌─────────────┬──────────────────┐
│ Web backend  │ Native backend   │
│ web-sys      │ wgpu crate       │
│ wasm-bindgen │ vo-ext #[vo_fn]  │
│ WebGPU API   │ Vulkan/Metal/DX12│
└─────────────┴──────────────────┘
```

Both use a shared `HandleRegistry<T>` to map `u32` handle IDs to actual GPU objects.

---

## 5. Directory Layout (Final)

```
volang/
├── apps/
│   └── playground-desktop/         # NEW: Tauri native playground
│       ├── src-tauri/
│       │   ├── Cargo.toml
│       │   ├── tauri.conf.json
│       │   ├── build.rs
│       │   └── src/main.rs
│       └── src/                    # Shared Svelte (symlink or copy)
├── libs/
│   ├── vogui/                      # MODIFIED: VoguiPlatform trait
│   │   ├── rust/src/
│   │   │   ├── lib.rs              # Platform trait + set_platform()
│   │   │   ├── externs.rs          # Dispatch through trait
│   │   │   ├── wasm_platform.rs    # WasmPlatform (current JS imports)
│   │   │   └── tauri_platform.rs   # TauriPlatform (Tauri events)
│   │   └── js/                     # Unchanged
│   ├── vo-tauri/                   # NEW: Tauri bridge crate
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── commands.rs
│   │       ├── gui_state.rs
│   │       └── platform.rs
│   └── vox/                        # Unchanged
├── 3rdparty/
│   └── wgpu/                       # MODIFIED: dual backend
│       ├── wgpu.vo                 # Expanded API (~65 functions)
│       ├── types.vo                # NEW: descriptors + enums
│       ├── rust/src/
│       │   ├── lib.rs              # cfg dispatch
│       │   ├── registry.rs         # NEW: handle registry
│       │   ├── protocol.rs         # NEW: JSON types
│       │   ├── web/                # REFACTORED from current lib.rs
│       │   └── native/             # NEW: wgpu crate backend
│       ├── wgpu.wasm / wgpu.js
│       └── vo.ext.toml             # MODIFIED: supports native too
└── playground/                     # MODIFIED: platform abstraction
    └── src/lib/
        ├── platform.ts             # NEW: VoPlatform interface
        ├── wasm-platform.ts        # NEW: wraps vo.ts
        └── tauri-platform.ts       # NEW: wraps Tauri invoke
```

---

## 6. Dependency Graph

```
apps/playground-desktop
  └── libs/vo-tauri
        ├── vo-engine (compile + run)
        ├── libs/vogui/rust (GUI externs)
        └── 3rdparty/wgpu/rust [native feature]
              └── wgpu crate (Vulkan/Metal/DX12)

playground/rust (existing web)
  └── vo-web
        ├── vo-vm, vo-runtime, vo-stdlib
        └── libs/vogui/rust (GUI externs, WASM platform)
  (wgpu loaded dynamically via ext bridge)
```

---

## 7. Implementation Order

| Phase | Task | Depends On | Effort |
|-------|------|-----------|--------|
| **P1** | vogui VoguiPlatform trait refactor | — | 1 day |
| **P2** | `libs/vo-tauri` crate (commands, gui_state) | P1 | 2 days |
| **P3** | Playground platform abstraction (TS) | — | 1 day |
| **P4** | `apps/playground-desktop` Tauri shell | P2, P3 | 2 days |
| **P5** | wgpu handle registry + protocol (shared) | — | 1 day |
| **P6** | wgpu web backend refactor (from current lib.rs) | P5 | 2 days |
| **P7** | wgpu Vo API expansion (types.vo, wgpu.vo) | P5 | 2 days |
| **P8** | wgpu native backend (wgpu crate + vo-ext) | P5, P7 | 3 days |
| **P9** | Tauri canvas overlay (native surface) | P4, P8 | 2 days |
| **P10** | Integration test: web playground + wgpu | P6, P7 | 1 day |
| **P11** | Integration test: native playground + wgpu | P8, P9 | 1 day |
| **Total** | | | **~18 days** |

P1–P4 (Tauri + playground) and P5–P8 (wgpu) can proceed in parallel.

---

## 8. Testing Strategy

### Unit Tests
- `vo-tauri`: Mock VM, verify IPC command serialization
- `vo-wgpu/registry`: Handle alloc/free/get correctness
- `vo-wgpu/protocol`: JSON round-trip for all descriptor types

### Integration Tests
- **Web playground**: Existing wgpu demo (`wgpu_demo.vo`) renders triangle
- **Native playground**: Same demo, verify native surface creation + render
- **Cross-platform parity**: Run identical `.vo` test programs on both, compare GPU output (screenshot diff or success/failure status)

### Vo Test Programs
```
tests/wgpu/
├── triangle.vo          # Basic render pipeline + draw
├── clear_color.vo       # Surface configure + clear
├── uniform_buffer.vo    # Buffer + bind group + uniform
├── texture.vo           # Texture creation + sampling
├── compute.vo           # Compute pipeline + dispatch
└── multi_pass.vo        # Multiple render passes
```

Each test: init wgpu, create resources, render one frame, verify no error.

---

## 9. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Tauri webview doesn't support WebGPU | Low (Chromium ≥113) | High | Detect at startup, show error |
| Native child window overlay Z-order issues | Medium | Medium | Platform-specific fixes; fallback to separate window |
| wgpu crate API drift vs WebGPU spec | Low | Medium | Pin wgpu version, abstract differences in registry layer |
| JSON serialization overhead on hot path | Medium | Low | Acceptable for v1; batch command buffer protocol for v2 |
| Vo `any` limitations for descriptor types | Medium | Medium | Use concrete struct types with json tags, not `any` |
