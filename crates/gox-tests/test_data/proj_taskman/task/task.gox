// Package task provides task management
package task

import "utils"

// Priority levels
const (
    PriorityLow      = 1
    PriorityMedium   = 2
    PriorityHigh     = 3
    PriorityCritical = 4
)

// Status values
const (
    StatusPending    = 0
    StatusInProgress = 1
    StatusCompleted  = 2
    StatusCancelled  = 3
)

// taskData holds internal task data (private struct)
type taskData struct {
    id       int
    title    string
    priority int
    status   int
}

// TaskManager manages tasks using object semantics (reference type)
// Object is used here because:
// - It needs mutable internal state
// - Methods modify the object's state
// - Reference semantics allow shared access
type TaskManager object {
    tasks  []taskData
    nextID int
    count  int
}

// NewTaskManager creates a new TaskManager
func NewTaskManager() TaskManager {
    return TaskManager{
        tasks:  make([]taskData, 0),
        nextID: 1,
        count:  0,
    }
}

// AddTask adds a new task and returns its ID
func (m TaskManager) AddTask(title string, priority int) int {
    id := m.nextID
    m.nextID = m.nextID + 1
    
    t := taskData{
        id:       id,
        title:    title,
        priority: utils.Clamp(priority, PriorityLow, PriorityCritical),
        status:   StatusPending,
    }
    m.tasks = append(m.tasks, t)
    m.count = m.count + 1
    
    return id
}

// GetStatus returns the status of a task
func (m TaskManager) GetStatus(id int) int {
    for i := 0; i < m.count; i++ {
        if m.tasks[i].id == id {
            return m.tasks[i].status
        }
    }
    return -1
}

// GetTitle returns the title of a task
func (m TaskManager) GetTitle(id int) string {
    for i := 0; i < m.count; i++ {
        if m.tasks[i].id == id {
            return m.tasks[i].title
        }
    }
    return ""
}

// GetPriority returns the priority of a task
func (m TaskManager) GetPriority(id int) int {
    for i := 0; i < m.count; i++ {
        if m.tasks[i].id == id {
            return m.tasks[i].priority
        }
    }
    return 0
}

// StartTask changes task status to in-progress
func (m TaskManager) StartTask(id int) bool {
    for i := 0; i < m.count; i++ {
        if m.tasks[i].id == id {
            if m.tasks[i].status == StatusPending {
                m.tasks[i].status = StatusInProgress
                return true
            }
            return false
        }
    }
    return false
}

// CompleteTask changes task status to completed
func (m TaskManager) CompleteTask(id int) bool {
    for i := 0; i < m.count; i++ {
        if m.tasks[i].id == id {
            if m.tasks[i].status == StatusInProgress {
                m.tasks[i].status = StatusCompleted
                return true
            }
            return false
        }
    }
    return false
}

// CancelTask changes task status to cancelled
func (m TaskManager) CancelTask(id int) bool {
    for i := 0; i < m.count; i++ {
        if m.tasks[i].id == id {
            status := m.tasks[i].status
            if status == StatusPending || status == StatusInProgress {
                m.tasks[i].status = StatusCancelled
                return true
            }
            return false
        }
    }
    return false
}

// Count returns total number of tasks
func (m TaskManager) Count() int {
    return m.count
}

// CountByStatus returns number of tasks with given status
func (m TaskManager) CountByStatus(status int) int {
    result := 0
    for i := 0; i < m.count; i++ {
        if m.tasks[i].status == status {
            result = result + 1
        }
    }
    return result
}

// CountByPriority returns number of tasks with given priority
func (m TaskManager) CountByPriority(priority int) int {
    result := 0
    for i := 0; i < m.count; i++ {
        if m.tasks[i].priority == priority {
            result = result + 1
        }
    }
    return result
}
