package main

func main() {
    // Test 1: Simple closure without capture
    add := func(a int, b int) int {
        return a + b
    }
    assert(add(3, 4) == 7, "simple closure: 3+4 should be 7")
    
    // Test 2: Closure capturing one variable
    x := 10
    addX := func(y int) int {
        return x + y
    }
    assert(addX(5) == 15, "capture one var: 10+5 should be 15")
    
    // Test 3: Closure capturing multiple variables
    a := 100
    b := 200
    sumAB := func(c int) int {
        return a + b + c
    }
    assert(sumAB(50) == 350, "capture multiple vars: 100+200+50 should be 350")
    
    // Test 4: Multiple closures capturing same variable (read-only)
    factor := 5
    mul := func(n int) int {
        return n * factor
    }
    div := func(n int) int {
        return n / factor
    }
    assert(mul(20) == 100, "mul closure: 20*5 should be 100")
    assert(div(100) == 20, "div closure: 100/5 should be 20")
    
    // Test 5: Closure with multiple params and capture
    base := 1000
    compute := func(x int, y int) int {
        return base + x * y
    }
    assert(compute(3, 4) == 1012, "multi-param closure: 1000+3*4 should be 1012")
    
    // Test 6: Calling captured closure multiple times
    offset := 7
    addOffset := func(n int) int {
        return n + offset
    }
    assert(addOffset(10) == 17, "closure reuse: 10+7 should be 17")
    assert(addOffset(20) == 27, "closure reuse: 20+7 should be 27")
    assert(addOffset(30) == 37, "closure reuse: 30+7 should be 37")
    
    // Test 7: Nested closure - inner captures from parent's upvalue
    outer := 100
    level1 := func(x int) int {
        o := outer
        inner := func(y int) int {
            return o + x + y
        }
        return inner(5)
    }
    assert(level1(10) == 115, "nested closure: 100+10+5 should be 115")
    
    // Test 8: Deep nesting - 3 levels
    deep := 1000
    l1 := func(a int) int {
        d := deep
        l2 := func(b int) int {
            d2 := d
            a2 := a
            l3 := func(c int) int {
                return d2 + a2 + b + c
            }
            return l3(3)
        }
        return l2(2)
    }
    assert(l1(1) == 1006, "3-level nesting: 1000+1+2+3 should be 1006")
    
    // Test 9: 5 levels of nesting
    base5 := 10000
    n1 := func(v1 int) int {
        b := base5
        n2 := func(v2 int) int {
            b2 := b
            v1c := v1
            n3 := func(v3 int) int {
                b3 := b2
                v1c2 := v1c
                v2c := v2
                n4 := func(v4 int) int {
                    b4 := b3
                    v1c3 := v1c2
                    v2c2 := v2c
                    v3c := v3
                    n5 := func(v5 int) int {
                        return b4 + v1c3 + v2c2 + v3c + v4 + v5
                    }
                    return n5(5)
                }
                return n4(4)
            }
            return n3(3)
        }
        return n2(2)
    }
    assert(n1(1) == 10015, "5-level nesting: 10000+1+2+3+4+5 should be 10015")
    
    println("closure_test: ALL PASSED")
}
