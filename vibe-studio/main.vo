package main

import "../libs/vui"

// =============================================================================
// Events (UI → App)
// =============================================================================

type ClickIncrement struct{}
type ClickDecrement struct{}
type ClickReset struct{}
type SetSlider struct{ value int }
type ToggleDarkMode struct{ enabled bool }

// =============================================================================
// Signals (App → UI)
// =============================================================================

type UpdateUI struct {
	count    int
	slider   int
	darkMode bool
}

// =============================================================================
// App State & Logic
// =============================================================================

type AppState struct {
	count    int
	slider   int
	darkMode bool
}

func appInit() any {
	return AppState{count: 0, slider: 50, darkMode: false}
}

func appHandle(state any, event vui.Event) any {
	s := state.(AppState)
	switch e := event.(type) {
	case ClickIncrement:
		s.count++
	case ClickDecrement:
		s.count--
	case ClickReset:
		s.count = 0
	case SetSlider:
		s.slider = e.value
	case ToggleDarkMode:
		s.darkMode = e.enabled
	}
	return s
}

func appRender(state any) vui.Signal {
	s := state.(AppState)
	return UpdateUI{count: s.count, slider: s.slider, darkMode: s.darkMode}
}

// =============================================================================
// UI Model & View
// =============================================================================

type Model struct {
	count    int
	slider   int
	darkMode bool
}

func uiInit() any {
	return Model{count: 0, slider: 50, darkMode: false}
}

func uiApply(model any, signal vui.Signal) any {
	m := model.(Model)
	switch sig := signal.(type) {
	case UpdateUI:
		m.count = sig.count
		m.slider = sig.slider
		m.darkMode = sig.darkMode
	}
	return m
}

func uiView(model any) {
	m := model.(Model)
	vui.SetDarkMode(m.darkMode)
	vui.CentralPanel(func() {
		vui.Heading("Vibe Studio Demo")
		vui.Separator()
		vui.Label("Two-Fiber Architecture with Event/Signal")
		vui.Space(10)

		vui.CollapsingHeader("Counter", func() {
			vui.Horizontal(func() {
				if vui.Button("-") {
					vui.Send(ClickDecrement{})
				}
				vui.Label("  " + itoa(m.count) + "  ")
				if vui.Button("+") {
					vui.Send(ClickIncrement{})
				}
				vui.Space(20)
				if vui.Button("Reset") {
					vui.Send(ClickReset{})
				}
			})
		})

		vui.CollapsingHeader("Slider", func() {
			newVal, changed := vui.SliderInt("Value", m.slider, 0, 100)
			if changed {
				vui.Send(SetSlider{value: newVal})
			}
			vui.ProgressBar(float64(m.slider) / 100.0)
		})

		vui.CollapsingHeader("Settings", func() {
			newDark, changed := vui.Checkbox("Dark Mode", m.darkMode)
			if changed {
				vui.Send(ToggleDarkMode{enabled: newDark})
			}
		})
	})
}

func itoa(n int) string {
	if n == 0 {
		return "0"
	}
	neg := false
	if n < 0 {
		neg = true
		n = -n
	}
	var digits []byte
	for n > 0 {
		digits = append([]byte{byte('0' + n%10)}, digits...)
		n = n / 10
	}
	if neg {
		digits = append([]byte{'-'}, digits...)
	}
	return string(digits)
}

// =============================================================================
// Main
// =============================================================================

func main() {
	vui.RunWithApp(
		vui.Config{
			Title:  "Vibe Studio",
			Width:  800,
			Height: 600,
		},
		vui.App{
			Init:   appInit,
			Handle: appHandle,
			Render: appRender,
		},
		vui.UI{
			Init:  uiInit,
			Apply: uiApply,
			View:  uiView,
		},
	)
}
